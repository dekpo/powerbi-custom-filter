var OrgPassFilter;(()=>{"use strict";var e={639:(e,t,s)=>{function i(e,t){return{objectName:e,propertyName:t.name,selector:t.selector,altConstantValueSelector:t.altConstantSelector,instanceKind:t.instanceKind}}function a(e,t,s){return null==t||"object"==typeof t&&!t.solid?s:t.solid?{value:null==t?void 0:t.solid.color}:(null==e?void 0:e.items)?e.items.find(e=>e.value==t):t}s.d(t,{D:()=>a,y:()=>i})},667:(e,t,s)=>{s.d(t,{A:()=>i});const i=class{constructor(e){this.localizationManager=e}populateFormattingSettingsModel(e,t){var s,i,a;let r=new e,o=null===(i=null===(s=null==t?void 0:t[0])||void 0===s?void 0:s.metadata)||void 0===i?void 0:i.objects;return o&&(null===(a=r.cards)||void 0===a||a.forEach(e=>{var t,s,i;null===(t=null==e?void 0:e.slices)||void 0===t||t.forEach(t=>{null==t||t.setPropertiesValues(o,e.name)}),null===(i=null===(s=null==e?void 0:e.container)||void 0===s?void 0:s.containerItems)||void 0===i||i.forEach(t=>{var s;null===(s=null==t?void 0:t.slices)||void 0===s||s.forEach(t=>{null==t||t.setPropertiesValues(o,e.name)})})})),r}buildFormattingModel(e){var t;let s={cards:[]};return null===(t=e.cards)||void 0===t||t.forEach(e=>{if(!e)return;const t=e.name,i=e.name+"-group";let a={displayName:void 0,slices:[],uid:i},r=e.getFormattingCard(t,a,this.localizationManager);s.cards.push(r);const o={};if(e.container){const s=e.container,n=i+"-container",l={displayName:this.localizationManager&&s.displayNameKey?this.localizationManager.getDisplayName(s.displayNameKey):s.displayName,description:this.localizationManager&&s.descriptionKey?this.localizationManager.getDisplayName(s.descriptionKey):s.description,containerItems:[],uid:n};s.containerItems.forEach(e=>{const s=e.displayNameKey?e.displayNameKey:e.displayName,i=n+s;let a={displayName:this.localizationManager&&e.displayNameKey?this.localizationManager.getDisplayName(e.displayNameKey):e.displayName,slices:[],uid:i};this.buildFormattingSlices(e.slices,t,o,r,a.slices),l.containerItems.push(a)}),a.container=l}e.slices&&this.buildFormattingSlices(e.slices,t,o,r,a.slices),r.revertToDefaultDescriptors=this.getRevertToDefaultDescriptor(e)}),s}buildFormattingSlices(e,t,s,i,a){null==e||e.forEach(e=>{let r=null==e?void 0:e.getFormattingSlice(t,this.localizationManager);r&&(void 0===s[e.name]?s[e.name]=0:(s[e.name]++,r.uid=`${r.uid}-${s[e.name]}`),e.topLevelToggle?(r.suppressDisplayName=!0,i.topLevelToggle=r):a.push(r))})}getRevertToDefaultDescriptor(e){var t,s;const i={};let a=[],r=this.getSlicesRevertToDefaultDescriptor(e.name,e.slices,i),o=[];return null===(s=null===(t=e.container)||void 0===t?void 0:t.containerItems)||void 0===s||s.forEach(t=>{o=o.concat(this.getSlicesRevertToDefaultDescriptor(e.name,t.slices,i))}),a=r.concat(o),a}getSlicesRevertToDefaultDescriptor(e,t,s){let i=[];return null==t||t.forEach(t=>{t&&!s[t.name]&&(s[t.name]=!0,i=i.concat(t.getRevertToDefaultDescriptor(e)))}),i}}},674:(e,t,s)=>{s.d(t,{O:()=>a.A,z:()=>i});var i=s(754),a=s(667)},754:(e,t,s)=>{s.d(t,{Kx:()=>r,Zp:()=>o,jF:()=>l,ks:()=>d});var i=s(639);class a{}class r{}class o extends a{getFormattingCard(e,t,s){return{displayName:s&&this.displayNameKey?s.getDisplayName(this.displayNameKey):this.displayName,description:s&&this.descriptionKey?s.getDisplayName(this.descriptionKey):this.description,groups:[t],uid:e,analyticsPane:this.analyticsPane}}}class n extends a{constructor(e){super(),Object.assign(this,e)}getFormattingSlice(e,t){const s=this.type,i=this.name,a={displayName:t&&this.displayNameKey?t.getDisplayName(this.displayNameKey):this.displayName,description:t&&this.descriptionKey?t.getDisplayName(this.descriptionKey):this.description,uid:e+"-"+i};return Object.assign(Object.assign({},a),{control:{type:s,properties:this.getFormattingComponent(e,t)}})}getFormattingComponent(e,t){return{descriptor:i.y(e,this),value:this.value}}getRevertToDefaultDescriptor(e){return[{objectName:e,propertyName:this.name}]}setPropertiesValues(e,t){var s;let a=null===(s=null==e?void 0:e[t])||void 0===s?void 0:s[this.name];this.value=i.D(this,a,this.value)}}class l extends n{constructor(e){super(e),this.type="ToggleSwitch"}}class d extends n{constructor(e){super(e),this.type="TextInput"}getFormattingComponent(e){return Object.assign(Object.assign({},super.getFormattingComponent(e)),{placeholder:this.placeholder})}}},789:(e,t,s)=>{s.d(t,{v:()=>r});var i=s(674),a=s(980);class r{constructor(e){if(this.currentOrganization=null,this.allData=[],this.viewModel={dataPoints:[]},this.currentDataView=null,!e)throw new Error("VisualConstructorOptions is required");this.host=e.host,this.element=e.element,this.formattingSettingsService=new i.O;const t=document.createElement("div");t.className="passwordFilterContainer",this.titleLabel=document.createElement("div"),this.titleLabel.className="titleLabel",this.titleLabel.textContent="Login";const s=document.createElement("div");s.className="passwordSection",this.passwordInput=document.createElement("input"),this.passwordInput.type="password",this.passwordInput.className="passwordInput",this.passwordInput.placeholder="Enter password",this.submitButton=document.createElement("button"),this.submitButton.textContent="Enter",this.submitButton.className="submitButton",this.messageDiv=document.createElement("div"),this.messageDiv.className="messageDiv",s.appendChild(this.passwordInput),s.appendChild(this.submitButton),s.appendChild(this.messageDiv),t.appendChild(this.titleLabel),t.appendChild(s),this.element.appendChild(t),this.hidePowerBITitle(),this.submitButton.addEventListener("click",()=>this.handlePasswordSubmit()),this.passwordInput.addEventListener("keypress",e=>{"Enter"===e.key&&this.handlePasswordSubmit()})}update(e){var t,s,i;this.formattingSettings=this.formattingSettingsService.populateFormattingSettingsModel(a.S,e.dataViews);const r=(null===(i=null===(s=null===(t=this.formattingSettings)||void 0===t?void 0:t.general)||void 0===s?void 0:s.title)||void 0===i?void 0:i.value)||"Login";this.titleLabel&&(this.titleLabel.textContent=r);const o=e.dataViews[0];if(!o||!o.table)return void this.blockAllData();this.restorePasswordFromProperties(e),this.currentDataView=o,this.triggerAutoSubmitIfNeeded();const n=o.table,l=n.rows;if(!l||0===l.length)return void this.blockAllData();const d=n.columns.map(e=>e.displayName||e.queryName);this.allData=l.map(e=>{const t={};return d.forEach((s,i)=>{t[s]=e[i]}),t});const c=n.columns.findIndex(e=>{const t=(e.displayName||e.queryName||"").toLowerCase();return t.includes("organization")||t.includes("org")});this.viewModel.dataPoints=l.map((e,t)=>{const s=c>=0?String(e[c]||""):"",i=this.host.createSelectionIdBuilder();let a;return n.identity&&n.identity[t]?a=n.identity[t]:c>=0&&n.columns[c]?(i.withTable(n,t),a=i.createSelectionId()):a=i.createSelectionId(),{identity:a,org:s,...this.allData[t]}}),this.currentOrganization?this.applyFilter(this.currentOrganization):this.blockAllData()}handlePasswordSubmit(){const e=this.passwordInput.value.trim();if(console.log("[PasswordFilter] Password submitted:",e),this.savePasswordToProperties(e),!e)return this.showMessage("Please enter a password","error"),this.currentOrganization=null,void this.blockAllData();this.validateAndApplyPassword(e,!1)}getDefaultPasswordMapping(){return{FAO123:"FAO",UNICEF123:"UNICEF",UNHCR123:"UNHCR",WHO123:"WHO",WIPO123:"WIPO"}}blockAllData(){try{if(console.log("[PasswordFilter] Blocking all data access - no valid password"),!this.currentDataView||!this.currentDataView.table){const e={$schema:"http://powerbi.com/product/schema#basic",target:{},operator:"None"};return void this.host.applyJsonFilter(e,"general","filter",0)}const e=this.currentDataView.table,t=e.columns.findIndex(e=>{const t=(e.displayName||e.queryName||"").toLowerCase();return t.includes("organization")||t.includes("org")});if(t<0){const e={$schema:"http://powerbi.com/product/schema#basic",target:{},operator:"None"};return void this.host.applyJsonFilter(e,"general","filter",0)}const s=e.columns[t],i=s.queryName||s.displayName,a={$schema:"http://powerbi.com/product/schema#basic",target:{table:i.split(".")[0]||i,column:i.split(".").pop()||s.displayName},operator:"In",values:[]};console.log("[PasswordFilter] Applying blocking filter:",JSON.stringify(a,null,2)),this.host.applyJsonFilter(a,"general","filter",0)}catch(e){console.error("[PasswordFilter] Error blocking data:",e)}}applyFilter(e){try{if(!this.currentDataView||!this.currentDataView.table)return this.showMessage("No data view available for filtering","error"),void console.error("[PasswordFilter] No data view available");const t=this.currentDataView.table,s=t.columns.findIndex(e=>{const t=(e.displayName||e.queryName||"").toLowerCase();return t.includes("organization")||t.includes("org")});if(s<0)return this.showMessage("Organization column not found","error"),void console.error("[PasswordFilter] Organization column not found in columns:",t.columns.map(e=>e.displayName||e.queryName));const i=t.columns[s],a=i.queryName||i.displayName,r=a.split(".")[0]||a,o=a.split(".").pop()||i.displayName;console.log("[PasswordFilter] Applying filter:",{organization:e,tableName:r,columnName:o,queryName:a,displayName:i.displayName});const n={$schema:"http://powerbi.com/product/schema#basic",target:{table:r,column:o},operator:"In",values:[e]};console.log("[PasswordFilter] Filter JSON:",JSON.stringify(n,null,2)),this.host.applyJsonFilter(n,"general","filter",0),console.log("[PasswordFilter] Filter applied successfully")}catch(e){const t=(null==e?void 0:e.message)||String(e);this.showMessage(`Filter error: ${t}`,"error"),console.error("[PasswordFilter] Filter error:",e),console.error("[PasswordFilter] Error stack:",null==e?void 0:e.stack)}}showMessage(e,t){this.messageDiv.textContent=e,this.messageDiv.className=`messageDiv ${t}`,"success"===t&&setTimeout(()=>{this.messageDiv.textContent="",this.messageDiv.className="messageDiv"},3e3)}getFormattingModel(){return this.formattingSettingsService.buildFormattingModel(this.formattingSettings)}enumerateObjectInstances(e){return[]}savePasswordToProperties(e){try{this.host.persistProperties({merge:[{objectName:"passwordSettings",properties:{savedPassword:e},selector:void 0}]}),console.log("[PasswordFilter] Password saved using persistProperties")}catch(e){console.warn("[PasswordFilter] Failed to save password using persistProperties:",e)}}restorePasswordFromProperties(e){var t,s,i;try{if(this.passwordInput&&(null===(t=null==e?void 0:e.dataViews)||void 0===t?void 0:t[0])){const t=e.dataViews[0],a=null===(s=null==t?void 0:t.metadata)||void 0===s?void 0:s.objects,r=(null===(i=null==a?void 0:a.passwordSettings)||void 0===i?void 0:i.savedPassword)||"";if(r&&r.trim()){const e=this.passwordInput.value.trim();e&&e!==r||(this.passwordInput.value=r,console.log("[PasswordFilter] Password restored from persisted properties:",r))}}}catch(e){console.warn("[PasswordFilter] Failed to restore password from persisted properties:",e)}}triggerAutoSubmitIfNeeded(){try{if(this.passwordInput&&this.currentDataView&&this.currentDataView.table){const e=this.passwordInput.value.trim();e&&setTimeout(()=>{this.validateAndApplyPassword(e,!0)},200)}}catch(e){console.warn("[PasswordFilter] Failed to trigger auto-submit:",e)}}hidePowerBITitle(){var e;try{let t=this.element.parentElement,s=0;const i=5;for(;t&&s<i;){if(t.querySelectorAll('[class*="title"], [class*="header"], [class*="titleText"], [class*="visualTitle"]').forEach(e=>{const t=e;t.classList.contains("titleLabel")||(t.style.display="none")}),(t.textContent||"").trim()&&t!==this.element&&!t.contains(this.element)){const s=Array.from(t.children);1===s.length&&s[0]===this.element&&Array.from((null===(e=t.parentElement)||void 0===e?void 0:e.children)||[]).forEach(e=>{var s;if(e!==t&&e.textContent){const t=e;(null===(s=t.textContent)||void 0===s?void 0:s.trim())&&!t.contains(this.element)&&(t.style.display="none")}})}t=t.parentElement,s++}this.element.parentElement&&new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(1===e.nodeType){const t=e;t.querySelector&&(t.querySelector('[class*="title"]')||t.querySelector('[class*="header"]'))&&t.querySelectorAll('[class*="title"], [class*="header"]').forEach(e=>{const t=e;t.classList.contains("titleLabel")||(t.style.display="none")})}})})}).observe(this.element.parentElement,{childList:!0,subtree:!0})}catch(e){console.warn("[PasswordFilter] Failed to hide Power BI title:",e)}}validateAndApplyPassword(e,t=!1){var s,i,a;const r=(null===(a=null===(i=null===(s=this.formattingSettings)||void 0===s?void 0:s.filterSettings)||void 0===i?void 0:i.organizationMapping)||void 0===a?void 0:a.value)||this.getDefaultPasswordMapping();let o;try{o="string"==typeof r?JSON.parse(r):r}catch(e){console.warn("[PasswordFilter] Failed to parse mapping JSON, using default:",e),o=this.getDefaultPasswordMapping()}const n=o[e];n?(this.currentOrganization=n,t||this.showMessage("Access granted","success"),this.applyFilter(n)):t||(this.showMessage("Invalid password","error"),this.currentOrganization=null,this.blockAllData())}}},980:(e,t,s)=>{s.d(t,{S:()=>d});var i=s(674),a=i.z.Zp,r=i.z.Kx;class o extends a{constructor(){super(...arguments),this.title=new i.z.ks({name:"title",displayName:"Title",value:"Login",placeholder:"Enter component title"}),this.name="general",this.displayName="General",this.slices=[this.title]}}class n extends a{constructor(){super(...arguments),this.password=new i.z.ks({name:"password",displayName:"Password",value:"",placeholder:""}),this.showPassword=new i.z.jF({name:"showPassword",displayName:"Show Password",value:!1}),this.savedPassword=new i.z.ks({name:"savedPassword",displayName:"Saved Password",value:"",placeholder:""}),this.name="passwordSettings",this.displayName="Password Settings",this.slices=[this.password,this.showPassword,this.savedPassword]}}class l extends a{constructor(){super(...arguments),this.organizationMapping=new i.z.ks({name:"organizationMapping",displayName:"Organization Password Mapping",value:JSON.stringify({FAO123:"FAO",UNICEF123:"UNICEF",UNHCR123:"UNHCR",WHO123:"WHO",WIPO123:"WIPO"},null,2),placeholder:'{"password1":"FAO","password2":"UNICEF"}'}),this.name="filterSettings",this.displayName="Filter Settings",this.slices=[this.organizationMapping]}}class d extends r{constructor(){super(...arguments),this.general=new o,this.passwordSettings=new n,this.filterSettings=new l,this.cards=[this.general,this.passwordSettings,this.filterSettings]}}}},t={};function s(i){var a=t[i];if(void 0!==a)return a.exports;var r=t[i]={exports:{}};return e[i](r,r.exports,s),r.exports}s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};(()=>{s.r(i),s.d(i,{default:()=>r});var e=s(789),t=window.powerbi,a={name:"OrgPassFilter",displayName:"Login",class:"OrganizationPasswordFilter",apiVersion:"5.3.0",create:t=>{if(e.v)return new e.v(t);throw"Visual instance not found"},createModalDialog:(e,t,s)=>{const i=globalThis.dialogRegistry;e in i&&new i[e](t,s)},custom:!0};void 0!==t&&(t.visuals=t.visuals||{},t.visuals.plugins=t.visuals.plugins||{},t.visuals.plugins.OrgPassFilter=a);const r=a})(),OrgPassFilter=i})();